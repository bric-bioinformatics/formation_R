unique(HQ$sector)
HQ[HQ$sector=="",]
HQ[4103:4107,]
data <- read.csv2(file.path(data.dir,"data_final_d4g.csv"),dec = ".",quote="\"")
TH <- read.delim(file.path(data.dir,"tax_havens_Torslov_2022.tab"))
data$jur_tax_haven <- ifelse(data$jur_code%in%TH$Code,"TH","not.TH")
HQ <- read.csv(file.path(data.dir,"data_step2_before-currency-units.csv"))
HQ$mnc <- toupper(HQ$company)
HQ$hq <- toupper(HQ$hq)
data$upe_code <- HQ$hq[match(data$mnc,HQ$mnc)]
data$sector <- HQ$sector[match(data$mnc,HQ$mnc)]
unique(HQ$sector)
HQ[HQ$sector=="",]
summary(data$sector)
summary(factor(data$sector))
data[is.na(sector)]
data[is.na(data$sector),]
unique(data[is.na(data$sector),"mnc"])
data <- read.csv2(file.path(data.dir,"data_final_d4g.csv"),dec = ".",quote="\"")
TH <- read.delim(file.path(data.dir,"tax_havens_Torslov_2022.tab"))
data$jur_tax_haven <- ifelse(data$jur_code%in%TH$Code,"TH","not.TH")
HQ <- read.csv(file.path(data.dir,"data_step2_before-currency-units.csv"))
HQ$mnc <- toupper(HQ$company)
HQ$hq <- toupper(HQ$hq)
data$upe_code <- HQ$hq[match(gsub(" ","",data$mnc),HQ$mnc)]
data$sector <- HQ$sector[match(data$mnc,HQ$mnc)]
data[is.na(data$sector),]
data$sector <- HQ$sector[match(gsub(" ","",data$mnc),HQ$mnc)]
data[is.na(data$sector),]
data <- read.csv2(file.path(data.dir,"data_final_d4g.csv"),dec = ".",quote="\"")
TH <- read.delim(file.path(data.dir,"tax_havens_Torslov_2022.tab"))
data$jur_tax_haven <- ifelse(data$jur_code%in%TH$Code,"TH","not.TH")
HQ <- read.csv(file.path(data.dir,"data_step2_before-currency-units.csv"))
HQ$mnc <- toupper(HQ$company)
HQ$hq <- toupper(HQ$hq)
data$upe_code <- HQ$hq[match(gsub(" ","",data$mnc),HQ$mnc)]
data$sector <- HQ$sector[match(gsub(" ","",data$mnc),HQ$mnc)]
data[is.na(data$sector),]
data <- read.csv2(file.path(data.dir,"data_final_d4g.csv"),dec = ".",quote="\"")
TH <- read.delim(file.path(data.dir,"tax_havens_Torslov_2022.tab"))
data$jur_tax_haven <- ifelse(data$jur_code%in%TH$Code,"TH","not.TH")
HQ <- read.csv(file.path(data.dir,"data_step2_before-currency-units.csv"))
HQ$mnc <- toupper(HQ$company)
HQ$hq <- toupper(HQ$hq)
data$upe_code <- HQ$hq[match(gsub(" ","",data$mnc),HQ$mnc)]
data$sector <- HQ$sector[match(gsub(" ","",data$mnc),HQ$mnc)]
data[is.na(data$sector),]
data[,5:10] <- sapply(data[,5:10],as.numeric)
data[,5:10] <- sapply(data[,5:10],round)
data <- data.table(data)
data.profits <- data[profit_before_tax>0]
data.profits.ext <- data.profits[jur_code!=upe_code]
data.profits.HQ <- data.profits[jur_code==upe_code]
data.per.year <- unique(data[,list(mnc,year,sector,upe_code)])
data.per.year.report <- data.per.year[,list(count=length(mnc)),by=year]
ggplot(data.per.year.report,aes(x=year,y=count)) + theme_bw() +
geom_col(fill=colours()[124])
export.plot(file.path(main.dir,"results","nb_report_per_year"),width=6,height=4,export.formats = c("png","pdf"))
data.per.year.sector <- data.per.year[,list(count=length(mnc)),by=c("year","sector")]
data.per.year.sector
data.per.year <- unique(data[,list(mnc,year,sector,upe_code)])
data.per.year.sector
data[data$sector=="NC",]
HQ <- read.csv(file.path(data.dir,"data_step2_before-currency-units.csv"),quote="\"")
HQ$mnc <- toupper(HQ$company)
HQ$hq <- toupper(HQ$hq)
data$upe_code <- HQ$hq[match(gsub(" ","",data$mnc),HQ$mnc)]
data$sector <- HQ$sector[match(gsub(" ","",data$mnc),HQ$mnc)]
data[data$sector=="NC",]
HQ[HQ$sector=="NC",]
HQ <- read.csv(file.path(data.dir,"data_step2_before-currency-units.csv"),quote="\"")
HQ$mnc <- toupper(HQ$company)
HQ$hq <- toupper(HQ$hq)
data$upe_code <- HQ$hq[match(gsub(" ","",data$mnc),HQ$mnc)]
data$sector <- HQ$sector[match(gsub(" ","",data$mnc),HQ$mnc)]
HQ[HQ$sector=="NC",]
data.per.year <- unique(data[,list(mnc,year,sector,upe_code)])
data.per.year.sector <- data.per.year[,list(count=length(mnc)),by=c("year","sector")]
data.per.year.sector
length(unique(data.per.year.sector$sector))
unique(data.per.year.sector$year)
ggplot(data.per.year.report,aes(x=sector,y=count)) + theme_bw() +
geom_col(aes(fill=factor(year))) + scale_fill_manual(values=c("#e55792","#D53E4F", "#F46D43", "#FDAE61", "#FEE08B", "#E6F598", "#ABDDA4","#72e2bf", "#3288BD", "#a193e2"))
ggplot(data.per.year.sector,aes(x=sector,y=count)) + theme_bw() +
geom_col(aes(fill=factor(year))) + scale_fill_manual(values=c("#e55792","#D53E4F", "#F46D43", "#FDAE61", "#FEE08B", "#E6F598", "#ABDDA4","#72e2bf", "#3288BD", "#a193e2"))
ggplot(data.per.year.sector,aes(x=sector,y=count)) + theme_bw() +
geom_col(aes(fill=factor(year)),position="dodge") + coord_flip() + scale_fill_manual(values=c("#e55792","#D53E4F", "#F46D43", "#FDAE61", "#FEE08B", "#E6F598", "#ABDDA4","#72e2bf", "#3288BD", "#a193e2"))
ggplot(data.per.year.sector,aes(x=year,y=count)) + theme_bw() + facet_null(~sector) +
geom_col(aes(fill=factor(year))) + coord_flip() + scale_fill_manual(values=c("#e55792","#D53E4F", "#F46D43", "#FDAE61", "#FEE08B", "#E6F598", "#ABDDA4","#72e2bf", "#3288BD", "#a193e2"))
ggplot(data.per.year.sector,aes(x=year,y=count)) + theme_bw() + facet_wrap(~sector) +
geom_col(aes(fill=factor(year))) + coord_flip() + scale_fill_manual(values=c("#e55792","#D53E4F", "#F46D43", "#FDAE61", "#FEE08B", "#E6F598", "#ABDDA4","#72e2bf", "#3288BD", "#a193e2"))
ggplot(data.per.year.sector,aes(x=factor(year),y=count)) + theme_bw() +
geom_col(aes(fill=factor(year))) + coord_flip() + scale_fill_manual(values=c("#e55792","#D53E4F", "#F46D43", "#FDAE61", "#FEE08B", "#E6F598", "#ABDDA4","#72e2bf", "#3288BD", "#a193e2"))
ggplot(data.per.year.sector,aes(x=factor(year),y=count)) + theme_bw() + facet_wrap(~sector) +
geom_col(aes(fill=factor(year))) + scale_fill_manual(values=c("#e55792","#D53E4F", "#F46D43", "#FDAE61", "#FEE08B", "#E6F598", "#ABDDA4","#72e2bf", "#3288BD", "#a193e2"))
ggplot(data.per.year.sector,aes(x=factor(year),y=count)) + theme_bw() + facet_wrap(~sector) +  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
geom_col(aes(fill=factor(year))) + scale_fill_manual(values=c("#e55792","#D53E4F", "#F46D43", "#FDAE61", "#FEE08B", "#E6F598", "#ABDDA4","#72e2bf", "#3288BD", "#a193e2"))
export.plot(file.path(main.dir,"results","nb_report_per_sector"),width=20,height=15,export.formats = c("png","pdf"))
ggplot(data.per.year.report,aes(x=year,y=count)) + theme_bw() +
geom_col(aes(fill=factor(year))) + scale_fill_manual(values=c("#e55792","#D53E4F", "#F46D43", "#FDAE61", "#FEE08B", "#E6F598", "#ABDDA4","#72e2bf", "#3288BD", "#a193e2"))
export.plot(file.path(main.dir,"results","nb_report_per_year"),width=6,height=4,export.formats = c("png","pdf"))
data.per.year.country <- data.per.year[,list(count=length(mnc)),by=c("year","upe_code")]
data.per.year.country
length(unique(data.per.year.country$upe_code))
ggplot(data.per.year.country,aes(x=factor(year),y=count)) + theme_bw() + facet_wrap(~upe_code,ncol=6) +  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
geom_col(aes(fill=factor(year))) + scale_fill_manual(values=c("#e55792","#D53E4F", "#F46D43", "#FDAE61", "#FEE08B", "#E6F598", "#ABDDA4","#72e2bf", "#3288BD", "#a193e2"))
export.plot(file.path(main.dir,"results","nb_report_per_conutry"),width=20,height=18,export.formats = c("png","pdf"))
data.per.year <- data[,list(mnc,year,sector,upe_code)]
data.per.year.report <- data.per.year[,list(count=length(mnc)),by=year]
ggplot(data.per.year.report,aes(x=year,y=count)) + theme_bw() +
geom_col(aes(fill=factor(year))) + scale_fill_manual(values=c("#e55792","#D53E4F", "#F46D43", "#FDAE61", "#FEE08B", "#E6F598", "#ABDDA4","#72e2bf", "#3288BD", "#a193e2"))
export.plot(file.path(main.dir,"results","nb_report_per_year_all"),width=6,height=4,export.formats = c("png","pdf"))
data.per.year.sector <- data.per.year[,list(count=length(mnc)),by=c("year","sector")]
ggplot(data.per.year.sector,aes(x=factor(year),y=count)) + theme_bw() + facet_wrap(~sector) +  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
geom_col(aes(fill=factor(year))) + scale_fill_manual(values=c("#e55792","#D53E4F", "#F46D43", "#FDAE61", "#FEE08B", "#E6F598", "#ABDDA4","#72e2bf", "#3288BD", "#a193e2"))
export.plot(file.path(main.dir,"results","nb_report_per_sector_all"),width=20,height=15,export.formats = c("png","pdf"))
data.per.year.country <- data.per.year[,list(count=length(mnc)),by=c("year","upe_code")]
ggplot(data.per.year.country,aes(x=factor(year),y=count)) + theme_bw() + facet_wrap(~upe_code,ncol=6) +  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
geom_col(aes(fill=factor(year))) + scale_fill_manual(values=c("#e55792","#D53E4F", "#F46D43", "#FDAE61", "#FEE08B", "#E6F598", "#ABDDA4","#72e2bf", "#3288BD", "#a193e2"))
export.plot(file.path(main.dir,"results","nb_report_per_conutry_all"),width=20,height=18,export.formats = c("png","pdf"))
data[is.na(profit_before_tax)]
data[jur_code=="OTHER"]
data
data.ext.profit.only
data.profits.HQ
length(unique(data.profits.HQ$mnc))
length(unique(data.profits.ext$mnc))
write.table(data,file.path(main.dir,"data/dataset_multi_years_cleaned_completed.tab"),sep="\t",row.names = F, quote=F)
data.num <- data[,sapply(data,is.numeric)]
head(data.num )
data.num <- data[,sapply(data,is.numeric),with=F]
head(data.num )
data
data.melt <- melt(data,id.vars=c("mnc","upe_code","sector"))
head(data.melt)
data.melt <- melt(data,id.vars=c("year","mnc","upe_code","sector"))
head(data.melt)
data.melt <- melt(data[,-c(3,4,15),with=F],id.vars=c("year","mnc","upe_code","sector"))
head(data.melt)
data.melt$binary <- ifelse(is.na(data.melt$value,"not.reported","reported"))
data.melt$binary <- ifelse(is.na(data.melt$value),"not.reported","reported")
head(data.melt)
ggplot(data.num,aes(x=year)) + theme_bw() +
geom_bar(aes(fill=binary))
ggplot(data.melt,aes(x=year)) + theme_bw() +
geom_bar(aes(fill=binary))
ggplot(data.melt,aes(x=year)) + theme_bw() +
geom_bar(aes(fill=binary)) + facet_wrap(~variable)
ggplot(data.melt,aes(x=year)) + theme_bw() +
geom_bar(aes(fill=binary)) + facet_wrap(~variable) +
scale_fill_manual(values=c(reported=colours()[124],not.reported="grey"))
export.plot(file.path(main.dir,"results","multi_year_missing_data_abs"),width=15,height=15,export.formats = c("png","pdf"))
ggplot(data.melt,aes(x=year)) + theme_bw() +
geom_bar(aes(fill=binary),position="fill") + facet_wrap(~variable) +
scale_fill_manual(values=c(reported=colours()[124],not.reported="grey"))
export.plot(file.path(main.dir,"results","multi_year_missing_data_prop"),width=15,height=15,export.formats = c("png","pdf"))
data$year <- foctor(data$year)
data$year <- factor(data$year)
data.melt <- melt(data[,-c(3,4,15),with=F],id.vars=c("year","mnc","upe_code","sector"))
data.melt$binary <- ifelse(is.na(data.melt$value),"not.reported","reported")
ggplot(data.melt,aes(x=year)) + theme_bw() +
geom_bar(aes(fill=binary)) + facet_wrap(~variable) +
scale_fill_manual(values=c(reported=colours()[124],not.reported="grey"))
export.plot(file.path(main.dir,"results","multi_year_missing_data_abs"),width=15,height=15,export.formats = c("png","pdf"))
ggplot(data.melt,aes(x=year)) + theme_bw() +
geom_bar(aes(fill=binary),position="fill") + facet_wrap(~variable) +
scale_fill_manual(values=c(reported=colours()[124],not.reported="grey"))
export.plot(file.path(main.dir,"results","multi_year_missing_data_prop"),width=15,height=15,export.formats = c("png","pdf"))
data.melt <- data.table(data.melt)
data.melt
head(data)
data.melt <- melt(data[,-c(4,15),with=F],id.vars=c("year","mnc","upe_code","sector","jur_code"))
dim(data.melt)
data.melt <- melt(data[,-c(4),with=F],id.vars=c("year","mnc","upe_code","sector","jur_code","jur_tax_haven"))
data.melt$binary <- ifelse(is.na(data.melt$value),"not.reported","reported")
unique(data$jur_code)
sort(unique(data$jur_code))
sort(unique(data$jur_name))
sort(unique(data[jur_code=="OTHER"]$jur_name))
data$jur_tax_haven[data$jur_code=="OTHER"] <- "UNKNOWN"
data.melt <- melt(data[,-c(4),with=F],id.vars=c("year","mnc","upe_code","sector","jur_code","jur_tax_haven"))
data.melt$binary <- ifelse(is.na(data.melt$value),"not.reported","reported")
dim(data.melt)
data.melt <- data.table(data.melt)
data.melt.per.report <- data.melt[,list(status=ifelse(sum(variable=="reported")==10,"complete",paste(sum(variable!="reported"),"missing",collapse=" "))),by=c()]
data.melt
data.melt.per.report <- data.melt[,list(status=ifelse(sum(binary=="reported")==10,"complete",paste(sum(binary!="reported"),"missing",collapse=" "))),by=c("year","mnc","upe_code","sector jur_code","jur_tax_haven")]
data.melt.per.report <- data.melt[,list(status=ifelse(sum(binary=="reported")==10,"complete",paste(sum(binary!="reported"),"missing",collapse=" "))),by=c("year","mnc","upe_code","sector","jur_code","jur_tax_haven")]
data.melt.per.report
data.melt.per.report[status=="complete"]
data.melt.per.report <- data.melt[,list(status.binary=ifelse(sum(binary=="reported")==10,"complete","incomplete"), status=ifelse(sum(binary=="reported")==10,"complete",paste(sum(binary!="reported"),"missing",collapse=" "))),by=c("year","mnc","upe_code","sector","jur_code","jur_tax_haven")]
ggplot(data.melt.per.report,aes(x=year)) + theme_bw() +
geom_bar(aes(fill=status.binary)) + facet_wrap(~variable) +
scale_fill_manual(values=c(colplete=colours()[124],incomplete="grey"))
ggplot(data.melt.per.report,aes(x=year)) + theme_bw() +
geom_bar(aes(fill=status.binary)) +
scale_fill_manual(values=c(colplete=colours()[124],incomplete="grey"))
export.plot(file.path(main.dir,"results","multi_year_complete_data_abs"),width=15,height=15,export.formats = c("png","pdf"))
ggplot(data.melt.per.report,aes(x=year)) + theme_bw() +
geom_bar(aes(fill=status.binary)) +
scale_fill_manual(values=c(complete=colours()[124],incomplete="grey"))
export.plot(file.path(main.dir,"results","multi_year_complete_data_abs"),width=15,height=15,export.formats = c("png","pdf"))
ggplot(data.melt.per.report,aes(x=year)) + theme_bw() +
geom_bar(aes(fill=status.binary)) +
scale_fill_manual(values=c(complete=colours()[124],incomplete="grey"))
export.plot(file.path(main.dir,"results","multi_year_complete_data_abs"),width=8,height=8,export.formats = c("png","pdf"))
ggplot(data.melt.per.report,aes(x=year)) + theme_bw() +
geom_bar(aes(fill=status.binary),position="fill") + facet_wrap(~variable) +
scale_fill_manual(values=c(complete=colours()[124],incomplete="grey"))
ggplot(data.melt.per.report,aes(x=year)) + theme_bw() +
geom_bar(aes(fill=status.binary),position="fill") +
scale_fill_manual(values=c(complete=colours()[124],incomplete="grey"))
export.plot(file.path(main.dir,"results","multi_year_complete_data_prop"),width=8,height=8,export.formats = c("png","pdf"))
data.profits <- data.table(data.profits)
data.profits
data.profits.melt <- melt(data.profits[,-c(4),with=F],id.vars=c("year","mnc","upe_code","sector","jur_code","jur_tax_haven"))
head(data.profits.melt)
ggplot(data.profits,aes(x=year,y=value)) + theme_bw() +
geom_col(aes(fill=jur_tax_haven)) + facet_wrap(~jur_code) +
scale_fill_manual(values=c(not.TH=colours()[124],UNKNOWN="grey",TH="black"))
ggplot(data.profits,aes(x=year,y=profit_before_tax)) + theme_bw() +
geom_col(aes(fill=jur_tax_haven)) + facet_wrap(~jur_code) +
scale_fill_manual(values=c(not.TH=colours()[124],UNKNOWN="grey",TH="black"))
ggplot(data.profits,aes(x=year,y=profit_before_tax)) + theme_bw() +
geom_col(aes(fill=jur_tax_haven)) + facet_wrap(~upe_code) + scale_y_log10() +
scale_fill_manual(values=c(not.TH=colours()[124],UNKNOWN="grey",TH="black"))
data$jur_tax_haven[data$jur_code=="OTHER"] <- "UNKNOWN"
data.profits <- data[profit_before_tax>0]
data.profits.ext <- data.profits[jur_code!=upe_code]
data.profits.HQ <- data.profits[jur_code==upe_code]
data.profits <- data.table(data.profits.ext)
ggplot(data.profits,aes(x=year,y=profit_before_tax)) + theme_bw() +
geom_col(aes(fill=jur_tax_haven)) + facet_wrap(~upe_code) + scale_y_log10() +
scale_fill_manual(values=c(not.TH=colours()[124],UNKNOWN="grey",TH="black"))
export.plot(file.path(main.dir,"results","multi_year_profits_TH_abs"),width=8,height=8,export.formats = c("png","pdf"))
ggplot(data.profits,aes(x=year,y=profit_before_tax)) + theme_bw() +
geom_col(aes(fill=jur_tax_haven),position="fill") + facet_wrap(~upe_code,strip.position = "right") + scale_y_log10() +
scale_fill_manual(values=c(not.TH=colours()[124],UNKNOWN="grey",TH="black"))
export.plot(file.path(main.dir,"results","multi_year_profits_TH_prop"),width=8,height=8,export.formats = c("png","pdf"))
4721/8846
ggplot(data.profits,aes(x=year,y=profit_before_tax)) + theme_bw() +
geom_col(aes(fill=jur_tax_haven)) + facet_wrap(~upe_code,strip.position = "right") + scale_y_log10() +
scale_fill_manual(values=c(not.TH=colours()[124],UNKNOWN="grey",TH="black")) +  theme(axis.text.x = element_text(angle = 90, hjust = 1))
export.plot(file.path(main.dir,"results","multi_year_profits_TH_abs"),width=8,height=8,export.formats = c("png","pdf"))
ggplot(data.profits,aes(x=year,y=profit_before_tax)) + theme_bw() +
geom_col(aes(fill=jur_tax_haven),position="fill") + facet_wrap(~upe_code,strip.position = "right") + scale_y_log10() +
scale_fill_manual(values=c(not.TH=colours()[124],UNKNOWN="grey",TH="black")) +  theme(axis.text.x = element_text(angle = 90, hjust = 1))
export.plot(file.path(main.dir,"results","multi_year_profits_TH_prop"),width=8,height=8,export.formats = c("png","pdf"))
ggplot(data.profits,aes(x=year,y=profit_before_tax)) + theme_bw() +
geom_col(aes(fill=jur_tax_haven)) + facet_wrap(~upe_code,strip.position = "right") + scale_y_log10() +
scale_fill_manual(values=c(not.TH=colours()[124],UNKNOWN="grey",TH="black")) +  theme(axis.text.x = element_text(angle = 90, hjust = 1))
export.plot(file.path(main.dir,"results","multi_year_profits_TH_abs"),width=10,height=8,export.formats = c("png","pdf"))
ggplot(data.profits,aes(x=year,y=profit_before_tax)) + theme_bw() +
geom_col(aes(fill=jur_tax_haven),position="fill") + facet_wrap(~upe_code,strip.position = "right") + scale_y_log10() +
scale_fill_manual(values=c(not.TH=colours()[124],UNKNOWN="grey",TH="black")) +  theme(axis.text.x = element_text(angle = 90, hjust = 1))
export.plot(file.path(main.dir,"results","multi_year_profits_TH_prop"),width=10,height=8,export.formats = c("png","pdf"))
ggplot(data.profits,aes(x=year,y=profit_before_tax)) + theme_bw() +
geom_col(aes(fill=jur_tax_haven),position="fill") + facet_wrap(~upe_code,strip.position = "right") +
scale_fill_manual(values=c(not.TH=colours()[124],UNKNOWN="grey",TH="black")) +  theme(axis.text.x = element_text(angle = 90, hjust = 1))
export.plot(file.path(main.dir,"results","multi_year_profits_TH_prop"),width=10,height=8,export.formats = c("png","pdf"))
ggplot(data.profits,aes(x=year,y=profit_before_tax)) + theme_bw() +
geom_col(aes(fill=jur_tax_haven)) + facet_wrap(~upe_code,strip.position = "right") + scale_y_log10() +
scale_fill_manual(values=c(not.TH=colours()[124],UNKNOWN="grey",TH="black")) +  theme(axis.text.x = element_text(angle = 90, hjust = 1))
ggplot(data.profits,aes(x=year,y=profit_before_tax)) + theme_bw() +
geom_col(aes(fill=jur_tax_haven)) + facet_wrap(~upe_code,strip.position = "right") +
scale_fill_manual(values=c(not.TH=colours()[124],UNKNOWN="grey",TH="black")) +  theme(axis.text.x = element_text(angle = 90, hjust = 1))
ggplot(data.profits,aes(x=year,y=profit_before_tax/10^9)) + theme_bw() +
geom_col(aes(fill=jur_tax_haven)) + facet_wrap(~upe_code,strip.position = "right") +
scale_fill_manual(values=c(not.TH=colours()[124],UNKNOWN="grey",TH="black")) +  theme(axis.text.x = element_text(angle = 90, hjust = 1))
export.plot(file.path(main.dir,"results","multi_year_profits_TH_abs"),width=10,height=8,export.formats = c("png","pdf"))
data.profits.melt <- melt(data.profits[,-c(4),with=F],id.vars=c("year","mnc","upe_code","sector","jur_code","jur_tax_haven"))
data.profits.melt$binary <- ifelse(is.na(data.profits.melt$value),0,1)
data.profits.melt
data.profits.melt$ID_branch <- paste(data.profits.melt$mnc,data.profits.melt$jur_code,sep="_")
data.profits.melt
data.profits.tab <- as.data.frame.matrix(xtabs(binary~ID_branch+year,data=data.profits.melt))
head(data.profits.tab )
data.profits$ID_branch <- paste(data.profits$mnc,data.profits$jur_code,sep="_")
data.profits.tab <- as.data.frame.matrix(xtabs(count~ID_branch+year,data=data.profits))
data.profits$count <- 1
data.profits.tab <- as.data.frame.matrix(xtabs(count~ID_branch+year,data=data.profits))
head(data.profits.tab)
data.profits.tab$nb.year <- rowsum(data.profits.tab)
data.profits.tab$nb.year <- rowSums(data.profits.tab)
head(data.profits.tab)
head(data.profits.tab[data.profits.tab$nb.year>8,])
head(data.profits.tab[data.profits.tab$nb.year>6,])
head(data.profits.tab[data.profits.tab$nb.year>5,])
data.profits.per.comp <- unique(data.profits[,list(mnc,year,upe_code,count=1)])
data.profits.per.comp
data.profits.tab <- as.data.frame.matrix(xtabs(count~mnc+year,data=data.profits.per.comp))
head(data.profits.tab)
data.profits.tab$nb.year <- rowSums(data.profits.tab)
head(data.profits.tab)
head(data.profits.tab,20)
head(data.profits.tab,50)
dim(data.profits.tab)
write.table(data.profits.tab,file.path(main.dir,"results","reported_profits_per_company.tab"),sep="\t",quote=F)
data.profits.tab$upe_code <- data.profits[match(row.names(data.profits.tab),mnc)]$upe_code
head(data.profits.tab)
write.table(data.profits.tab,file.path(main.dir,"results","reported_profits_per_company.tab"),sep="\t",quote=F)
library(pheatmap)
sum(data.profits.tab$nb.year>1)
111/150
sum(data.profits.tab$nb.year>2)
data.profits
data.profits$ETR <- data.profits$tax_paid/data.profits$profit_before_tax
data.profits
data.profits[tax_paid<0]$tax_paid <- 0
data.profits$ETR <- data.profits$tax_paid/data.profits$profit_before_tax
head(data.profits)
sum(is.na(data.profits$ETR))
sum(!is.na(data.profits$ETR))
data.profits$count <- ifelse(is.na(data.profits$ETR),0,1)
data.profits.year <- as.data.frame.matrix(xtabs(count~ID_branch+year,data=data.profits))
head(data.profits)
head(data.profits.year)
dim(data.profits.year)
annotation.branch <- unique(as.data.frame(data.profits)[,c("ID_branch","upe_code","sector")])
row.names(annotation.branch) <- annotation.branch$ID_branch
annotation.branch$ID_branch <- NULL
pheatmap(data.profits.year,
cluster_cols = F,
cluster_rows = F,
annotation_row = annotation.branch,
show_rownames = F)
pheatmap(data.profits.year,
cluster_cols = F,
cluster_rows = F,
annotation_row = annotation.branch,
show_rownames = F,
color = c("white","black"))
pheatmap(data.profits.year,
cluster_cols = F,
cluster_rows = F,
annotation_row = annotation.branch,
show_rownames = F,
color = c("white","black"),
breaks=c(0,1))
data.profits.year[data.profits.year>1] <- 1
pheatmap(data.profits.year,
cluster_cols = F,
cluster_rows = F,
annotation_row = annotation.branch,
show_rownames = F,
color = c("white","black"))
pheatmap(data.profits.year[order(rowSums(data.profits.year),decreasing = T),],
cluster_cols = F,
cluster_rows = F,
annotation_row = annotation.branch,
show_rownames = F,
color = c("white","black"))
years.in.row <- apply(data.profits.year,1,function(x){
tmp <- 0
for (i in x){
if (i==0){
tmp <- 0
} else {
tmp <- tmp + 1
}
}
})
head(years.in.row)
years.in.row <- apply(data.profits.year,1,function(x){
tmp <- 0
for (i in x){
if (i==0){
tmp <- 0
} else {
tmp <- tmp + 1
}
}
return tmp
years.in.row <- apply(data.profits.year,1,function(x){
tmp <- 0
for (i in x){
if (i==0){
tmp <- 0
} else {
tmp <- tmp + 1
}
}
return(tmp)
})
head(years.in.row <)
head(years.in.row )
years.in.row
years.in.row <- apply(data.profits.year,1,function(x){
count <- 0
tmp <- 0
for (i in x){
if (i==0){
if (count<tmp){
count <- tmp
}
tmp <- 0
} else {
tmp <- tmp + 1
if (count<tmp){
count <- tmp
}
}
}
return(count)
})
head(years.in.row,20)
data.profits.year[1:20,]
sum(years.in.row>2)
branch_ETR <- row.names(data.profits.year)[years.in.row>2]
branch_ETR <- unique(unlist(sapply(strsplit(branch_ETR,"_"),"[[",1)))
length(unique(data.profits$mnc))
class(data.profits)
table(data.profits$mnc,data.profits$upe_code)
colSums(table(data.profits$mnc,data.profits$upe_code))
apply(as.data.frame.matrix(table(data.profits$mnc,data.profits$upe_code)),2,function(x) sum(x>0))
sum(apply(as.data.frame.matrix(table(data.profits$mnc,data.profits$upe_code)),2,function(x) sum(x>0)))
"/Users/elodiedarbo/Documents/enseignement/projet_M1/2024/" -> main.dir
main.dir
main.dir <- "/Users/elodiedarbo/Documents/enseignement/projet_M1/2024/"
library(data.table)
expression <- fread(file.path(main.dir,"TCGA-BLCA.htseq_counts.tsv.gz"))
pheno <- fread(file.path(main.dir,"TCGA-BLCA.GDC_phenotype.tsv.gz"))
survie <- fread(file.path(main.dir,"TCGA-BLCA.survival.tsv"))
head(expression)
pheno <- fread(file.path(main.dir,"TCGA-BLCA.GDC_phenotype.tsv.gz"))
survie <- fread(file.path(main.dir,"TCGA-BLCA.survival.tsv"))
pheno
pheno[days_to_collection.samples>1000]
pheno[days_to_collection.samples>1000][order(initial_weight.samples)]
expression <- round(2^expression)
expression
row.names(expression) <- expression$Ensembl_ID
expression$Ensembl_ID <- NULL
expression <- round(2^expression)
head(expression)
colanmes(pheno)
colnames(pheno)
table(pheno$diagnosis_subtype)
table(pheno$tumor_stage.diagnoses)
table(pheno$hist_of_non_mibc)
table(pheno$hist_of_non_mibc,pheno$diagnosis_subtype)
table(pheno$hist_of_non_mibc,pheno$tumor_stage.diagnoses)
table(pheno$hist_of_non_mibc,pheno$classification_of_tumor.diagnoses)
table(pheno$hist_of_non_mibc,pheno$disease_type)
pheno <- pheno[hist_of_non_mibc!=""]
head(pheno <- pheno[hist_of_non_mibc!=""])
survie
pheno <- pheno[hist_of_non_mibc!="",list(sample=submitter_id.samples,non_MIBC=hist_of_non_mibc)]
pheno <- merge(pheno,survie,by="sample")
pheno
pheno$`_PATIENT` <- NULL
m <- match(colnames(expression),pheno$sample)
head(m)
expression <- as.data.frame(expression)
m <- match(colnames(expression),pheno$sample)
expression <- expression[,!is.na(m)]
pheno <- pheno[na.omit(m)]
head(colnames(expression))
pheno
head(expression)
expression <- fread(file.path(main.dir,"TCGA-BLCA.htseq_counts.tsv.gz"))
expression <- as.data.frame(expression)
row.names(expression) <- expression$Ensembl_ID
expression$Ensembl_ID <- NULL
m <- match(colnames(expression),pheno$sample)
expression <- expression[,!is.na(m)]
pheno <- pheno[na.omit(m)]
head(expression)
write.table(expression,file.path(main.dir,"expression_HTseq_Bladder_cancer_TCGA.tab"),sep="\t",quote=F)
write.table(pheno,file.path(main.dir,"clinical_Bladder_cancer_TCGA.tab"),sep="\t",quote=F,row.names=F)
expression <- round(2^expression)
write.table(expression,file.path(main.dir,"expression_HTseq_Bladder_cancer_TCGA.tab"),sep="\t",quote=F)
head()
head(expression)
pheno
?colours
23265/121977
11280/65344
9870/72618
22560/165984
60630/174924
load("~/Documents/projects/Santamaria/data/pure_TCGA_clin_expr.RData")
head(pure.expr)
head(pure.TCGA)
setwd("Documents/O·D·I·L/formation_R/")
dir.create("data")
setwd("data")
colnames(pure.expr) <- gsub("-",".",colnames(pure.expr))
row.names(pure.TCGA) <- gsub("-",".",row.names(pure.TCGA))
head(pure.TCGA)
head(pure.expr)
write.table(pure.TCGA,"TCGA_LUAD_subset.tsv",sep="\t",quote=F)
write.csv(pure.TCGA,"TCGA_LUAD_subset.csv",quote=F)
MAPK_regulators <- read.delim("~/Documents/projects/Santamaria/data/MAPK_regulators.tab", row.names=1)
View(MAPK_regulators)
pure.expr <- pure.expr[row.names(MAPK_regulators),]
write.table(pure.expr,"TCGA_LUAD_expression_subset.tsv",sep="\t",quote=F)
summary(MAPK_regulators)
apply(MAPK_regulators,2,sum)
setwd("/Users/elodiedarbo/Documents/O·D·I·L/formation_R/data")
setwd("~")
setwd("/Users/elodiedarbo/Documents/O·D·I·L/formation_R/data")
TCGA_LUAD_subset <- read.delim("~/Documents/O·D·I·L/formation_R/data/TCGA_LUAD_subset.tsv", row.names=1)
View(TCGA_LUAD_subset)
TCGA_LUAD <- read.delim("~/Documents/O·D·I·L/formation_R/data/TCGA_LUAD_subset.tsv", row.names=1)
View(TCGA_LUAD)
setwd("/Users/elodiedarbo/Documents/O·D·I·L/formation_R/data")
TCGA_LUAD <- read.delim("~/Documents/O·D·I·L/formation_R/data/TCGA_LUAD_subset.tsv", row.names=1)
View(TCGA_LUAD)
head(TCGA_LUAD, n=10)
summary(TCGA_LUAD)
?merge
